<!DOCTYPE html>
<html lang= "en">
<meta charset ="utf-8"/>

<head>

</head>

<body>

        <svg id="container"  >
		</svg>

</body>


<style>

  .line {
    fill: none;
    stroke: orange;
    stroke-width: 3px;
  }
  
  .axis line,
  .axis circle {
    fill: none;
    stroke: steelblue;
    stroke-dasharray: 4;
  } 

	#tooltip{
			margin-top: 20px;
			color: #000000;
			font-size: 40px;
  }
		
</style>

<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://d3js.org/d3-collection.v1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-array@3"></script>


<script>
		 var width = 1000,
          height = 1000,
          radius = Math.min(width, height)/2.5 ;		
		
		var svg = d3.select("body").append("svg")
          .attr("width", width)
          .attr("height", height)
		  .append("g")
          .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")
		  		
		var promises = [
			d3.csv("30companies.csv"),
			d3.csv("Comp_Cont3.csv"),
			d3.csv("Continent_Perc.csv")]
		Promise.all(promises).then(ready)
		function ready([company, cont, perc]) {
		
		var arcData = [
			{startAngle: 213.75*Math.PI/180, endAngle: 360*Math.PI/180},
			{startAngle: 101.25*Math.PI/180, endAngle: 191.25*Math.PI/180}				
		];
		
		
		var rect =svg.append("rect")
			.attr("x", 0-width)
			.attr("y", 0-height)
			.attr("width", width*2)
			.attr("height", height*2)
			.attr("fill", "LightGray")
			
		
		var arcGenerator = d3.arc()
			.innerRadius(10)
			.outerRadius(radius)
			.padAngle(.02)
			.padRadius(100)
			.cornerRadius(10);	
			
		svg.append('g')
			.selectAll('path')
			.data(arcData)
			.join('path')
			.attr('d', arcGenerator)
			.attr("fill", "white")
			.attr("stroke", "grey")


		
		maxValue=d3.max(cont, d=>d.Max_perc)
		//console.log("max-pct-value", maxValue)
							
		var color = d3.scaleOrdinal()
				.domain([0 , maxValue])
				.range(["#F8B195","#F67280","#C06C84", "#6C5B7B","#355C7D" , "#2980b9" ])
				
		let size= d3.scaleLinear()
					.domain([0,maxValue])
					.range([20,50]);	
		var r = d3.scaleLinear()
					  .domain([maxValue+10,0])
					  .range([100, radius]);
		var BGcircles = svg.append("g")
				.attr("class", "r axis")
				.selectAll("g")
				.data(r.ticks(maxValue*0.5).slice(1))
				.enter().append("g");
		
		BGcircles.append("circle")
          .attr("r", r)
		  .style("opacity", 0.3)
		  
		var cont_map = new Map();
		d3.map(cont, function (d) {
				cont_map.set(d.Continent,
					[d.Start_angle, d.End_angle, d.Max_perc])
			})
		
		/*  */
		/*  var groupedData = d3.nest()
            .key(function (d) { return d.Continent; })
            .entries(perc);*/
		var band_map= new Map()
		var arr_perc=[]		
		d3.map(company, function (d) {
		arr_perc.push(d.Percentage)					
		if (band_map.has(d.Continent)){
		band_map.get(d.Continent).push(d.Percentage)		
		}
		else {
		band_map.set(d.Continent, [d.Percentage])
		}
		})
		var band = d3.scaleBand()
		.range([0, 2 * Math.PI])  
		.domain( (function(d) { return d.Percentage; }) );
		
		///==============================================//
		
		
		sub_arr1=[]		
		sub_arr4=[]
		sub_arr5=[]
		sub_arr6=[]	
			
		d3.map(company, function (d) {
				if (d.Percentage>=3 && d.Percentage<=15) {					
					sub_arr1.push(d.Percentage)
					
				}else if (d.Percentage>=1.5 && d.Percentage<3) {					
					sub_arr4.push(d.Percentage)
					
				}else if (d.Percentage>=1 && d.Percentage<1.5) {					
					sub_arr5.push(d.Percentage)
					
				}else if (d.Percentage>=0.5 && d.Percentage<1) {					
					sub_arr6.push(d.Percentage)
					
				}
			})
			console.log(
			sub_arr1,		
		sub_arr4,
		sub_arr5,
		sub_arr6
	
		)	
			
				
		
		var line = d3.radialLine()
			.angle(function(d) {
					var cont_angle_max_pct_data = cont_map.get(d.Continent);
					var cont_max_pct = cont_angle_max_pct_data[2]; 
					var cont_start_angle = (cont_angle_max_pct_data[0])*Math.PI/180;
					var cont_end_angle = (cont_angle_max_pct_data[1])*Math.PI/180;
					
					var sub_arr = sub_arr6;
					if(d.Percentage>=3 && d.Percentage<=15){
						sub_arr = sub_arr1;
					}else if(d.Percentage>=1.5 && d.Percentage<3){
						sub_arr =  sub_arr4;
					}else if(d.Percentage>=1 && d.Percentage<1.5){
						sub_arr =  sub_arr5;
					}else if(d.Percentage>=0.5 && d.Percentage<1){
						sub_arr =  sub_arr6
					}
					
					var continent_angle_scale_fn = d3.scaleBand()					
						.domain(sub_arr)// band_map.get(d.Continent) );
						.range([ cont_end_angle, cont_start_angle+0.2 ]);
												
					return continent_angle_scale_fn(d.Percentage);
				})
							
			.radius(function(d) {
				if (d.Percentage>=14){
				return radius-(46*5);
				}else if(d.Percentage>=3 && d.Percentage<14){
				return radius-(46*4.5)
				}else if(d.Percentage>=2.5 && d.Percentage<3){
				return radius-(46*4)
				}else if(d.Percentage>=2 && d.Percentage<2.5){
				return radius-(46*3.5)
				}else if(d.Percentage>=1.5 && d.Percentage<2){
				return radius-(46*3)
				}else if(d.Percentage>=1 && d.Percentage<1.5){
				return radius-(46*2)
				}else if(d.Percentage>=0.5 && d.Percentage<1){
				return radius-(46)
				}else {
				return radius-20}
				
				
				//console.log(d.Continent, d.Company, d.Percentage, r(d.Percentage))
				//return 200-(10*d.Percentage);
			});
			
			console.log(band_map)
			
		let tooltip = d3.select('body')
                    .append('div')
                    .attr('id', 'tooltip')
                    .style('visibility', 'hidden')
                    .style('width',100 )
                    .style('height',100)
					
		 
			//.style("stroke","grey")

		var center_circle=svg.append("g")		
			.append("circle")
			.attr("fill", "LightGray")
			.attr("r", 130)
			.attr("cx", 0)
			.attr("cy", 0)
			.style("stroke", "gray")
			
		var white_individual_bubble_background=
			svg.append("g")
			.selectAll("circle")		
			.data(company)
			.enter()
			.append("circle")
			.attr("fill", "white")
			.attr("r", d=>size(d.Percentage)+8)
			.attr("transform", function(d) {
				var coors = line([d]).slice(1).slice(0, -1);
				return "translate(" + coors + ")"
						
			})	
			
		var nodes=svg.append("g")
			.selectAll("circle")		
			.data(company)
			.enter()
			.append("circle")
			.attr("fill", function(d){return color(d.Continent)})
			.attr("r", d=>size(d.Percentage))
			.attr("transform", function(d) {
				var coors = line([d]).slice(1).slice(0, -1);
				return "translate(" + coors + ")"
						
			})	
			.on("mouseover", (d) => {
							tooltip.transition()
							.style("visibility", "visible")

							tooltip.text(d.Company+","+d.Percentage+","+d.Continent)
							})
		    .on("mouseout", (item) => {
							tooltip.transition()
							.style("visibility", "hidden")
							})    
						
							
			
		  

		var line2 = d3.radialLine()
			.angle(function(d) {
					var cont_angle_max_pct_data = cont_map.get(d.Continent);
					var cont_max_pct = cont_angle_max_pct_data[2]; 
					var cont_start_angle = (cont_angle_max_pct_data[0])*Math.PI/180;
					var cont_end_angle = (cont_angle_max_pct_data[1])*Math.PI/180;
					
					var sub_arr = sub_arr6;
					if(d.Percentage>=3 && d.Percentage<=15){
						sub_arr = sub_arr1;
					}else if(d.Percentage>=1.5 && d.Percentage<3){
						sub_arr =  sub_arr4;
					}else if(d.Percentage>=1 && d.Percentage<1.5){
						sub_arr =  sub_arr5;
					}else if(d.Percentage>=0.5 && d.Percentage<1){
						sub_arr =  sub_arr6
					}
					
					var continent_angle_scale_fn = d3.scaleBand()					
						.domain(sub_arr)// band_map.get(d.Continent) );
						.range([ cont_end_angle, cont_start_angle+0.2]);
												
					return continent_angle_scale_fn(d.Percentage);
				})
							
			.radius(function(d) {
				if (d.Percentage>=14){
				return radius-(46*4.9);
				}else if(d.Percentage>=3 && d.Percentage<14){
				return radius-(46*4.4)
				}else if(d.Percentage>=2.5 && d.Percentage<3){
				return radius-(46*3.9)
				}else if(d.Percentage>=2 && d.Percentage<2.5){
				return radius-(46*3.4)
				}else if(d.Percentage>=1.5 && d.Percentage<2){
				return radius-(46*2.9)
				}else if(d.Percentage>=1 && d.Percentage<1.5){
				return radius-(46*1.9)
				}else if(d.Percentage>=0.5 && d.Percentage<1){
				return radius-(45)
				}else {
				return radius-19}
				
				
				//console.log(d.Continent, d.Company, d.Percentage, r(d.Percentage))
				//return 200-(10*d.Percentage);
			});
		let size2= d3.scaleLinear()
					.domain([0,maxValue])
					.range([10,12]);	
		var text=svg.append("g")
					.selectAll("text")
					.data(company)
					.enter()
					.append('text')
					.text(d => d.Company)
					.attr('fill', 'black')
					//.attr('font-size', 200)
					.attr("transform", function(d) {
						var coors = line2([d]).slice(1).slice(0, -1);
						console.log(coors)
						return "translate(" + coors + ")"								
								})	
					.attr("text-anchor", "middle")
					.attr("font-family", "sans-serif")
					.attr("font-size", d=>size2(d.Percentage))
					.attr("dx", ".71em")
		
		
		var center_circle=svg.append("g")		
			.append("text")
			.text("Top 30 Emitting Companies")
			.attr("fill", "black")
			.attr("text-anchor", "middle")
			.attr("font-size",20)
			
			
	
			
			
		
	
}
</script>

</html>
